@Scheduled(cron = "0 0 1 * * *")
    public void updateLateTasks() {

        LocalDate today = LocalDate.now();

        // Fetch all open tasks
        List<Task> openTasks = taskRepository.findByStatus(TaskStatus.OPEN);

        for (Task task : openTasks) {

            if (task.getDueDate() != null 
                    && today.isAfter(task.getDueDate())) {

                task.setStatus(TaskStatus.LATE);
            }
        }

        taskRepository.saveAll(openTasks);
    }


public class TimeZoneUtil {

    private static final Map<String, ZoneId> COUNTRY_ZONE_MAP = Map.of(
            "IN", ZoneId.of("Asia/Kolkata"),
            "US", ZoneId.of("America/New_York"),
            "UK", ZoneId.of("Europe/London"),
            "SG", ZoneId.of("Asia/Singapore")
            // Add more
    );

    public static LocalTime getUserLocalTime(String countryCode) {
        ZoneId userZone = COUNTRY_ZONE_MAP.getOrDefault(countryCode, ZoneId.of("UTC"));
        return ZonedDateTime.now(userZone).toLocalTime();
    }
}


public interface NotificationLogRepository 
        extends JpaRepository<NotificationLog, BigInteger> {

    Optional<NotificationLog> findByTaskIdAndEmail(BigInteger taskId, String email);
}

@Entity
public class NotificationLog {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long taskId;
    private String email;

    private Integer reminderSent;   // null=no attempt, 0=failed, 1=sent
    private Integer alertSent;

    private String reminderFailureReason;
    private String alertFailureReason;
}

@Service
public class NotificationProcessor {

    @Autowired
    private NotificationLogRepository logRepo;

    @Autowired
    private EmailService emailService;

    public void processNotifications(List<Task> tasks, 
                                     Map<String, String> userCountryMap) {

        for (Task task : tasks) {
            String assigneeEmail = task.getAssigneeEmail();
            if (assigneeEmail == null) continue;

            String countryCode = userCountryMap.get(assigneeEmail);
            if (countryCode == null) continue;

            LocalTime userLocalTime = TimeZoneUtil.getUserLocalTime(countryCode);

            // Check time >= 08:30 AM
            if (userLocalTime.isBefore(LocalTime.of(8, 30))) {
                continue;
            }

            // Check if NotificationLog already exists
            Optional<NotificationLog> logOpt =
                    logRepo.findByTaskIdAndEmail(task.getId(), assigneeEmail);

            if (logOpt.isPresent() && logOpt.get().getReminderSent() != null) {
                continue; // already attempted
            }

            NotificationLog log = logOpt.orElse(new NotificationLog());
            log.setTaskId(task.getId());
            log.setEmail(assigneeEmail);

            try {
                emailService.send(task);
                log.setReminderSent(1);
                log.setReminderFailureReason(null);
            } catch (Exception ex) {
                log.setReminderSent(0);
                log.setReminderFailureReason(ex.getMessage());
            }

            logRepo.save(log);
        }
    }
}

@Service
public class NotificationScheduler {

    @Autowired
    private ActionRepository repo;

    @Autowired
    private AssigneeService assigneeService;

    @Autowired
    private NotificationService notificationService;

    // Run every 5 minutes
    @Scheduled(fixedRate = 300000)
    public void processNotifications() {

        List<Action> actions = repo.findByStatus("OPEN");

        for (Action action : actions) {

            AssigneeInfo info = assigneeService.getAssigneeInfo(action.getAssignee());
            ZoneId zoneId = assigneeService.getZoneId(info.getCountry());

            LocalDate due = action.getDueDate();

            LocalDateTime preDueLocal = due.minusDays(1).atTime(9, 0);
            LocalDateTime postDueLocal = due.plusDays(1).atTime(9, 0);

            ZonedDateTime nowLocal = ZonedDateTime.now(zoneId);

            // Pre-due notification
            if (!action.isPreDueNotificationSent() &&
                nowLocal.toLocalDate().isEqual(preDueLocal.toLocalDate()) &&
                nowLocal.getHour() == 9 &&
                nowLocal.getMinute() <= 5) {

                notificationService.send(info.getEmail(),
                        "Action is due tomorrow",
                        action);

                action.setPreDueNotificationSent(true);
            }

            // Post-due notification
            if (!action.isPostDueNotificationSent() &&
                nowLocal.toLocalDate().isEqual(postDueLocal.toLocalDate()) &&
                nowLocal.getHour() == 9 &&
                nowLocal.getMinute() <= 5) {

                notificationService.send(info.getEmail(),
                        "Action is overdue",
                        action);

                action.setPostDueNotificationSent(true);
            }

            repo.save(action);
        }

    }
}
